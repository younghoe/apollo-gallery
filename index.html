<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Apollo's Life Gallery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    img, video {
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    img:hover, video:hover {
      transform: scale(1.1);
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-5">
    <h1 class="text-center mb-4">Apollo's Life Gallery</h1>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-primary" id="uploadButton">사진 업로드</button>
      <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display: none;">
    </div>

    <div class="row row-cols-2 row-cols-md-4 g-3" id="gallery">
      <!-- 썸네일 표시 -->
    </div>
  </div>

  <!-- 모달 팝업 -->
  <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center" id="modalBody">
          <!-- 미디어 표시 -->
        </div>
        <div class="modal-footer justify-content-center">
          <button class="btn btn-warning" id="editButton">수정</button>
          <button class="btn btn-danger" id="deleteButton">삭제</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWuzPf1n4ODEC1FSHXtuBkXYRzjoPrQt8",
      authDomain: "apollo-gallery-95212.firebaseapp.com",
      projectId: "apollo-gallery-95212",
      storageBucket: "apollo-gallery-95212.appspot.com",
      messagingSenderId: "358087073772",
      appId: "1:358087073772:web:806840b3aa47c3a966aac9"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    const uploadButton = document.getElementById('uploadButton');
    const fileInput = document.getElementById('fileInput');
    const gallery = document.getElementById('gallery');
    const mediaModal = new bootstrap.Modal(document.getElementById('mediaModal'));
    const modalBody = document.getElementById('modalBody');
    const deleteButton = document.getElementById('deleteButton');
    const editButton = document.getElementById('editButton');

    let currentFileRef = null; // 현재 클릭된 파일 참조

    uploadButton.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', async (event) => {
      const files = Array.from(event.target.files);

      for (const file of files) {
        const storageRef = storage.ref().child(`uploads/${file.name}`);
        await storageRef.put(file);
      }
      loadGallery();
      fileInput.value = ''; // 초기화
    });

    async function loadGallery() {
      gallery.innerHTML = '';
      const listRef = storage.ref('uploads/');
      const res = await listRef.listAll();

      for (const itemRef of res.items) {
        const url = await itemRef.getDownloadURL();
        const metadata = await itemRef.getMetadata();

        const col = document.createElement('div');
        col.className = 'col';

        if (metadata.contentType.startsWith('image/')) {
          col.innerHTML = `<img src="${url}" class="img-fluid rounded shadow-sm" data-path="${itemRef.fullPath}">`;
        } else if (metadata.contentType.startsWith('video/')) {
          col.innerHTML = `
            <video class="img-fluid rounded shadow-sm" controls data-path="${itemRef.fullPath}">
              <source src="${url}" type="${metadata.contentType}">
            </video>
          `;
        }
        gallery.appendChild(col);

        // 클릭 이벤트 연결
        col.querySelector('img, video').addEventListener('click', (e) => {
          openModal(url, metadata.contentType, itemRef);
        });
      }
    }

    function openModal(url, contentType, itemRef) {
      currentFileRef = itemRef;
      if (contentType.startsWith('image/')) {
        modalBody.innerHTML = `<img src="${url}" class="img-fluid rounded">`;
      } else if (contentType.startsWith('video/')) {
        modalBody.innerHTML = `
          <video class="img-fluid rounded" controls>
            <source src="${url}" type="${contentType}">
          </video>
        `;
      }
      mediaModal.show();
    }

    deleteButton.addEventListener('click', async () => {
      if (currentFileRef) {
        await currentFileRef.delete();
        mediaModal.hide();
        loadGallery();
        alert('삭제 완료!');
      }
    });

    editButton.addEventListener('click', () => {
      alert('수정 기능은 준비 중입니다!');
    });

    loadGallery(); // 페이지 처음 열 때 갤러리 로드
  </script>

</body>
</html>
